# Deploying on Red Hat OpenShift Container Platform (OCP)

Multiple templates are provided to satisfy various needs:

- **template-w-build.yaml**: **build EtherCalc from source code** repo defined by **GIT_REPO** and **GIT_REPO_REF** parameters. The **Dockerfile** included in this directory will be used to create the image. Use it if:
  - you want to deploy your development environment on OCP
  -
- **template-wo-build.yaml**: deploy **official Docker Hub EtherCalc image** and configure it to use a **standalone Redis instance*.
  - doesn't work at time of writing since the official image runs as uid 0 (user "root") which is forbidden by default on OpenShift.

An additional template fixing the official Docker Hub EtherCalc image could be added in the future.

Many EtherCalc/Redis instances can be deployed in the same project since all OpenShift created objects are tagged using an autogenerated deployment id. You can specify one using the **DEPL_ID** parameter.

## How to use the templates

### Deploying the templates on OCP

```
$ oc create -f .openshift/template-w-build.yaml
$ oc create -f .openshift/template-wo-build.yaml
```

### Deploy your instance

To build from source:

```
$ TEMPLATE="ethercalc-w-build"
$ oc new-app $TEMPLATE -p GIT_REPO=https://github.com/<your_id>/<your repo> -p GIT_REPO_REF=<your branch>
```

It is not mandatory to define the GIT_REPO and GIT_REPO_REF parameters. If you don't specify them, it defaults to the official source code repo [audreyt/ethercalc](https://github.com/audreyt/ethercalc/) and *master* branch.

To specify a custom deployment ID:

```
$ DEPL_ID=myid
$ oc new-app $TEMPLATE -p DEPL_ID=$DEPL_ID
```

To use the official image, **that currently doesn't work**:

```
$ TEMPLATE="ethercalc-wo-build"
$ oc new-app $TEMPLATE
```

## Cleaning up

### Tearing down the instances

You can delete the deployed apps, keeping the secrets, configmaps and volumes using the following:

```
$ oc delete all -l app=ethercalc-$DEPL_ID
```

Keep in mind that it will fail if you try to instanciate once again the template using the same DEPL_ID as pvc, secrets and cm are still defined using the same name...

If you want to delete everything, use:

```
$ oc delete all,pvc,secret,cm -l app=ethercalc-$DEPL_ID
```

### Deleting the templates

You can delete the templates using the following:

```
$ oc delete template -l template=ethercalc
```
